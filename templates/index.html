<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALE Pair Finder</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4DA3FF;
            --secondary-color: #6BB3FF;
            --accent-color: #3385E6;
            --success-color: #00C99C;
            --warning-color: #FFB366;
            --danger-color: #FF6B6B;
            --bg-color: #1A1A1A;
            --card-bg: #2D2D2D;
            --text-color: #E5E5E5;
            --text-muted: #A0A0A0;
            --border-color: #404040;
            --hover-bg: #333333;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Courier New', 'Courier', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 15px;
        }

        .header {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 1.5rem 1rem;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .container {
            max-width: 1100px;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        .container-full-width {
            max-width: 100%;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.6rem;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .label-hint {
            font-weight: 400;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }

        textarea, input[type="number"], select {
            width: 100%;
            padding: 0.85rem 0.95rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: 'Courier New', 'Courier', monospace;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--bg-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Courier New', 'Courier', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .progress-container {
            display: none;
            margin: 2rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: var(--hover-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid;
        }

        .status-pending {
            background: rgba(255, 159, 64, 0.1);
            color: var(--warning-color);
            border-color: var(--warning-color);
        }
        .status-processing {
            background: rgba(0, 102, 204, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .status-completed {
            background: rgba(0, 166, 126, 0.1);
            color: var(--success-color);
            border-color: var(--success-color);
        }
        .status-failed {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .results-container {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--hover-bg);
            color: var(--text-color);
            padding: 1.75rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid;
            font-size: 0.95rem;
        }

        .alert-info {
            background: rgba(0, 102, 204, 0.05);
            border-color: rgba(0, 102, 204, 0.2);
            color: var(--text-color);
        }

        .alert-success {
            background: rgba(0, 166, 126, 0.05);
            border-color: rgba(0, 166, 126, 0.2);
            color: var(--text-color);
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.05);
            border-color: rgba(231, 76, 60, 0.2);
            color: var(--text-color);
        }

        table.dataTable {
            border-collapse: collapse;
            width: 100% !important;
        }

        .dataTables_wrapper {
            padding: 1rem 0;
        }

        /* DataTables Styling */
        table.dataTable thead th,
        table.dataTable tbody td {
            color: var(--text-color);
            background-color: var(--card-bg);
        }

        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .footer {
            text-align: center;
            padding: 3rem 2rem 2rem 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
            margin-top: 3rem;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Collapsible details */
        .details-row {
            background: var(--bg-color);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
        }

        .rvd-display {
            font-family: 'Courier New', 'Courier', monospace;
            background: var(--hover-bg);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        code {
            font-family: 'Courier New', 'Courier', monospace;
            background: var(--hover-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }

        /* Section headers for form organization */
        .form-section-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .form-section-header:first-of-type {
            margin-top: 0;
        }

        /* Grid layouts for parameters */
        .form-row-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-row-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .form-row-2col,
            .form-row-3col {
                grid-template-columns: 1fr;
            }
        }

        /* Genomic Browser Visualization */
        .genomic-browser {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .browser-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .browser-controls select,
        .browser-controls input[type="range"] {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .browser-controls label {
            font-size: 0.9rem;
            margin-bottom: 0;
            color: var(--text-muted);
        }

        .browser-svg-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow-x: auto;  /* Changed from 'auto' to 'overflow-x: auto' */
            overflow-y: hidden; /* Added this line */
            min-height: 300px;
            max-height: 600px; /* Add a max height to prevent vertical growth */
            width: 100%;
        }

        #genomicBrowser {
            display: block;
        }

        .tale-forward {
            fill: var(--primary-color);
            stroke: var(--accent-color);
            stroke-width: 2;
        }

        .tale-reverse {
            fill: var(--success-color);
            stroke: #00A67E;
            stroke-width: 2;
        }

        .spacer-region {
            fill: var(--text-muted);
            opacity: 0.3;
        }

        .sequence-track {
            stroke: var(--border-color);
            stroke-width: 2;
        }

        .position-marker {
            stroke: var(--text-muted);
            stroke-width: 1;
            stroke-dasharray: 2,2;
        }

        .position-label {
            fill: var(--text-muted);
            font-size: 10px;
            font-family: 'Courier New', monospace;
        }

        .tale-label {
            fill: white;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .tooltip-browser {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            display: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .tooltip-browser .tooltip-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .tooltip-browser .tooltip-content {
            color: var(--text-color);
        }

        .legend-container {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: opacity 0.2s ease;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-item.disabled {
            opacity: 0.3;
        }

        .legend-item.disabled .legend-box {
            background: transparent !important;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 2px solid;
        }

        .view-mode-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-mode-toggle .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .view-mode-toggle .btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Navigation controls */
        .navigation-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            padding: 0.5rem;
            background: var(--hover-bg);
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .navigation-controls input[type="number"] {
            width: 120px;
            padding: 0.4rem;
        }

        .navigation-controls .btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .navigation-controls label {
            font-size: 0.85rem;
            margin-bottom: 0;
            margin-right: 0.3rem;
        }

        .current-region {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Mini-map */
        .mini-map {
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            height: 40px;
            margin-bottom: 1rem;
            position: relative;
            cursor: pointer;
        }

        .mini-map-viewport {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(77, 163, 255, 0.3);
            border: 2px solid var(--primary-color);
            cursor: move;
        }

        .mini-map-tale {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            opacity: 0.8;
        }

        .mini-map-tale.forward {
            background: var(--primary-color);
        }

        .mini-map-tale.reverse {
            background: var(--success-color);
        }

        /* Track label */
        .track-label {
            fill: var(--text-muted);
            font-size: 10px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* Table row highlight animation */
        @keyframes highlightPulse {
            0%, 100% {
                background-color: rgba(77, 163, 255, 0.6);
                box-shadow: 0 0 0 0 rgba(77, 163, 255, 0.7);
            }
            50% {
                background-color: rgba(77, 163, 255, 0.8);
                box-shadow: 0 0 0 8px rgba(77, 163, 255, 0);
            }
        }

        .highlighted-row {
            animation: highlightPulse 1.5s ease-in-out;
            background-color: rgba(77, 163, 255, 0.6) !important;
            border-left: 4px solid var(--primary-color) !important;
            font-weight: 600 !important;
        }

        .highlighted-row td {
            border-top: 2px solid var(--primary-color) !important;
            border-bottom: 2px solid var(--primary-color) !important;
        }

        /* Info icon and tooltip */
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help;
            margin-left: 0.25rem;
            position: relative;
        }

        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.85rem;
            font-weight: normal;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .info-icon:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 6px solid transparent;
            border-top-color: var(--border-color);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üß¨ TALE Pair Finder</h1>
                <p>Fast, efficient TALE-TALEN pair discovery for genome engineering</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search Form -->
        <div class="card" id="searchCard">
            <h2 class="card-title">
                Search Parameters
            </h2>

            <form id="searchForm">
                <div class="form-group">
                    <label for="dna_sequence">
                        DNA Sequence
                        <span class="label-hint">(100 - 100,000 bp, only A, T, C, G)</span>
                    </label>
                    <textarea
                        id="dna_sequence"
                        name="dna_sequence"
                        required
                        placeholder="Enter your DNA sequence here (A, T, C, G only)..."
                    ></textarea>
                    <button type="button" class="btn btn-secondary" onclick="clearDNASequence()" style="margin-top: 0.5rem;">
                        Clear Text
                    </button>
                </div>

                <h3 class="form-section-header">TALE Length Parameters</h3>
                <div class="form-row-2col">
                    <div class="form-group">
                        <label for="min_tale_length">Min TALE Length</label>
                        <input type="number" id="min_tale_length" name="min_tale_length" value="20" min="10" max="30" required>
                    </div>
                    <div class="form-group">
                        <label for="max_tale_length">Max TALE Length</label>
                        <input type="number" id="max_tale_length" name="max_tale_length" value="20" min="10" max="30" required>
                    </div>
                </div>

                <h3 class="form-section-header">Spacer Length Parameters</h3>
                <div class="form-row-2col">
                    <div class="form-group">
                        <label for="min_spacer_length">Min Spacer Length</label>
                        <input type="number" id="min_spacer_length" name="min_spacer_length" value="30" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="max_spacer_length">Max Spacer Length</label>
                        <input type="number" id="max_spacer_length" name="max_spacer_length" value="30" min="1" max="100" required>
                    </div>
                </div>

                <h3 class="form-section-header">Advanced Options</h3>
                <div class="form-row-3col">
                    <div class="form-group">
                        <label for="g_code">Guanine Code</label>
                        <select id="g_code" name="g_code">
                            <option value="NH" selected>NH (Standard)</option>
                            <option value="NN">NN (Alternative)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="position">
                            Position (Optional)
                            <span class="info-icon" data-tooltip="Specific position to search around">i</span>
                        </label>
                        <input type="number" id="position" name="position" min="0">
                    </div>
                    <div class="form-group">
                        <label for="position_range">Position Range (Optional)</label>
                        <input type="number" id="position_range" name="position_range" min="0">
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Find TALE Pairs
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="loadExample()">
                        Load Example
                    </button>
                </div>
            </form>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer">
            <div class="card">
                <h2 class="card-title">
                    Search Progress
                </h2>
                <div class="alert alert-info">
                    <strong>Status:</strong> <span class="status-badge" id="statusBadge">Processing</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                <p style="text-align: center; margin-top: 1rem; color: var(--text-muted);">
                    Searching for TALE pairs... This may take a moment for large sequences.
                </p>
            </div>
        </div>

        <!-- Results -->
        <div class="results-container" id="resultsContainer">
            <div class="card">
                <h2 class="card-title">
                    Results Summary
                </h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPairs">0</div>
                        <div class="stat-label">TALE Pairs Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sequenceLength">0</div>
                        <div class="stat-label">Sequence Length (bp)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="searchTime">0s</div>
                        <div class="stat-label">Search Time</div>
                    </div>
                </div>

                <div class="alert alert-success">
                    <strong>Search completed!</strong> Found <span id="pairCount">0</span> TALE pairs.
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportResults('csv')">
                        Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults('tsv')">
                        Export TSV
                    </button>
                    <button class="btn btn-primary" onclick="resetSearch()">
                        New Search
                    </button>
                </div>
            </div>

            </div>
        </div>

        <div class="container-full-width">
            <div class="card">
                <h2 class="card-title">
                    Genomic Browser View
                </h2>

                <div class="view-mode-toggle">
                    <button class="btn btn-secondary active" id="browserViewBtn" onclick="toggleView('browser')">
                        Browser View
                    </button>
                    <button class="btn btn-secondary" id="tableViewBtn" onclick="toggleView('table')">
                        Table View
                    </button>
                </div>

                <div id="browserView" class="genomic-browser">
                    <div class="browser-controls">
                        <div>
                            <label>View Mode:</label>
                            <select id="viewModeSelector" onchange="onViewModeChange()">
                                <option value="compact">Compact (Split tracks)</option>
                                <option value="standard">Standard (Stacked)</option>
                                <option value="region">Region View (500bp)</option>
                            </select>
                        </div>
                        <div>
                            <label>Select TALE Pair:</label>
                            <select id="pairSelector" onchange="onPairChange()">
                                <option value="all">Show All Pairs</option>
                            </select>
                        </div>
                        <div>
                            <label>Color By:</label>
                            <select id="colorModeSelector" onchange="onColorModeChange()">
                                <option value="strand">Strand (Default)</option>
                                <option value="length">TALE Length</option>
                                <option value="spacer">Spacer Length</option>
                            </select>
                        </div>
                        <div>
                            <label>Zoom: <span id="zoomLabel">100%</span></label>
                            <input type="range" id="zoomSlider" min="50" max="400" value="100" step="10" oninput="updateZoom(this.value)">
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="exportSVG()">Download SVG</button>
                        </div>
                    </div>

                    <div class="navigation-controls" id="navigationControls" style="display: none;">
                        <label>Jump to:</label>
                        <input type="number" id="jumpPosition" placeholder="Position (bp)" min="0">
                        <button class="btn btn-secondary" onclick="jumpToPosition()">Go</button>
                        <span style="margin: 0 1rem;">|</span>
                        <button class="btn btn-secondary" onclick="navigateRegion('prev')">‚Üê Previous Region</button>
                        <button class="btn btn-secondary" onclick="navigateRegion('next')">Next Region ‚Üí</button>
                        <span style="margin: 0 1rem;">|</span>
                        <span class="current-region" id="currentRegion">Viewing: Full sequence</span>
                    </div>

                    <div class="mini-map" id="miniMap" style="display: none;">
                        <div class="mini-map-viewport" id="miniMapViewport"></div>
                    </div>

                    <div class="browser-svg-container" id="browserSvgContainer">
                        <svg id="genomicBrowser"></svg>
                    </div>

                    <div class="legend-container">
                        <div class="legend-item" style="cursor: pointer;" onclick="toggleFilter('forward')" id="legendForward">
                            <div class="legend-box tale-forward"></div>
                            <span>Forward Strand TALE</span>
                        </div>
                        <div class="legend-item" style="cursor: pointer;" onclick="toggleFilter('reverse')" id="legendReverse">
                            <div class="legend-box tale-reverse"></div>
                            <span>Reverse Strand TALE</span>
                        </div>
                        <div class="legend-item" style="cursor: pointer;" onclick="toggleFilter('spacer')" id="legendSpacer">
                            <div class="legend-box spacer-region"></div>
                            <span>Spacer Region</span>
                        </div>
                    </div>
                </div>

                <div id="tableView" class="card" style="display: none; box-shadow: none; border: none; padding: 0; margin: 0;">
                    <table id="resultsTable" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>RVD</th>
                                <th>Comp Start</th>
                                <th>Comp End</th>
                                <th>Comp RVD</th>
                                <th>Spacer Length</th>
                                <th>TALE Length</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tooltip-browser" id="browserTooltip"></div>
        </div>

        <!-- Error Display -->
        <div class="alert alert-error" id="errorAlert" style="display: none;">
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>
    </div>

    <div class="footer">
        <p>TALE Pair Finder v2.0 | Powered by FastAPI & Modern Bioinformatics</p>
        <p><a href="/about" style="color: var(--secondary-color);">About & Documentation</a></p>
    </div>

    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <script>
        let currentSessionId = null;
        let searchStartTime = null;
        let dataTable = null;
        let allPairs = [];
        let currentZoom = 100;
        let sequenceLength = 0;
        let visibilityFilters = {
            forward: true,
            reverse: true,
            spacer: true
        };
        let currentViewMode = 'compact';
        let currentColorMode = 'strand';
        let currentRegionStart = 0;
        let currentRegionEnd = 0;
        let regionSize = 500;

        // Load example sequence
        function loadExample() {
            const exampleSeq = "CTGTACTCACCTCAATAGTAATTATTCCTATAACCTTTCTGAGTATCCGGAGGTGGAAATCCGTCACAAATGAGAATGTATTTCCCCGATAATCATAATAGGACGCTTCTAAGTTTTTCCACTTGGTTAAGCCGGCTAGGCCTTTCTGCCTGAAGTTTCAATGCACTGCTGCCAACAGCCAGGCATTGTTTTAGGAGTATTATTCGAGGGCATTCAGAACTAACTTGTCGGGACTAGCCGAAGTAGTCATCAGGCTTATATAGCGAAAAACCCAGAACCCGGTTCCACGCTATGGAACGTCTTTAACTCTGGCAAGCAATTAAAAACAACGTAAATATTACGGATATAAACAGAAAAATAGCCGAATATATCTATTCATATTGTATCGATAAATAGCCTCGCGGAGCCATGTGTCATACTAGTCTGCGGAGTACTCTAGTTATGCATATGGTTCACAGGACACTCGTTGTTTTCGAATATACGCTTTATGTGACGGTTTTTAAGCACACTAATGCTCAGCATCATTTAAACCAGACTGATACTAGATCTATAAAGTCCGCCATGCAGACGATAGCTCACGGAGATTACCGACCAATCTATCTGATCGGCGACCATTTGTGTGGTACTGGAGCGGAGAGGTAACTATGATGCCGCTAACAACCTCTCTGTCGTCGCTAACGTTTATAGTCTAGTCTCATTATAATTGTATGCTATTCAGGGATTGACTAATACTGGAAAACATTTCAGTTAAAGTAATTTATACGACAGAGACCGTGTACCTACTAAATCTCTTTAATGTAAGTTCAGACTAATTGGTAGTTTGTCTAGAACTTAGATTTTAACAGTAGAGGATGCATGTTTTATTTTTATGATCCATTGATGTCCTTAAGGCTGCAATATATGCAACGAGGTAATCTTTGCGGTAAGTCCTAGTGCAATGGCACTTTTTTACTTTTGTCCTTGAGAAGAGGAGACGTCAGTGCAGATATCTTTAATGTGGTAATTGGAAGGATTCTTGGCCCTCCACCCTTAGACAGTGTATACTCTTCTATAAACGAGCTATTAGTTATGACATCCGAAGATTCAAAAAGGTGAGCGAATTTGGCCGATCCGAAAAGACGGACTTCAAAGTTACCTGACGACAGTTGCGCGTCCGTATCAAAATCTTCTTAATAAGCCCCCGTTACTGTTGGTTGAAGAGCCCAGAACGGATTGGCCAGATGTACAATTATATCACTTAATGACTTTTGGGTCACGGTGTGTTACCTTACAGGAATTAAGACCGTCCATTAATTTCCCTTGCATATATATTGCGTTTTTTTGTCTTTTTATCCGCTTACTTAGATAAAAGTGACATAGCTTCTTACCGAAACACCTCCGTACACAGTACGATCGCATGTCCCATGAGATTGATAGGTATACCAAGTGTTCTGTGAGCAACAAAAGCTTAAATGGGAAATACGCGGCCAAAAGTTGGTGCGAATACGAGTTGTAGCAATGTTGGTCTGACTATGATTTATATATTTCAGGCGGTATGTCTGCTTTGATCAACCTCTAATAGCTCGTTAGATAGTCTAGCTGCTGGTAATCACTCAATGATCTCGGCTCCCCATTGGTACTACGACGATTTTTAGAGAGCCAGCTACAATCGCTAATGTGAGGACAATGTAATATTAGCAAACAATAAGTCCCCAACTAGTTGTGACCTTTTGAAAAGTGAATTTCATAATATATGCTGTCTCATGCACATGGATAATTTGGACAAATTTGATTCAAGTCTGATCAACCTTTACACAGATCTAGAATCAAAAGCAATGATTTCCCAGGTGCAAAATAAAAATACTAGGTAACTAGAAGAATTGTGACGTTCTAAATGTTGGTCCATTTGAATCGCCATCTAGGATCACGTCGCCCTAAAAAAAAGATATCAGGAACTCTCCTCTTTAGCAGTCAGGTCTATGGAAACTACAAGACTAACCTTCCTAGCAACCGGGGGGTGG";
            document.getElementById('dna_sequence').value = exampleSeq;
        }

        // Clear DNA sequence
        function clearDNASequence() {
            document.getElementById('dna_sequence').value = '';
        }

        // Form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                dna_sequence: document.getElementById('dna_sequence').value.trim().toUpperCase(),
                min_tale_length: parseInt(document.getElementById('min_tale_length').value),
                max_tale_length: parseInt(document.getElementById('max_tale_length').value),
                min_spacer_length: parseInt(document.getElementById('min_spacer_length').value),
                max_spacer_length: parseInt(document.getElementById('max_spacer_length').value),
                g_code: document.getElementById('g_code').value,
                position: document.getElementById('position').value ? parseInt(document.getElementById('position').value) : null,
                position_range: document.getElementById('position_range').value ? parseInt(document.getElementById('position_range').value) : null
            };

            // Hide results and errors
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';

            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;

            searchStartTime = Date.now();

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    pollSearchStatus();
                } else {
                    showError(data.detail || 'Search failed');
                    document.getElementById('progressContainer').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // Poll search status
        async function pollSearchStatus() {
            try {
                const response = await fetch(`/api/status/${currentSessionId}`);
                const data = await response.json();

                // Update progress
                document.getElementById('progressFill').style.width = data.progress + '%';
                document.getElementById('progressFill').textContent = data.progress + '%';

                // Update status badge
                const badge = document.getElementById('statusBadge');
                badge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                badge.className = 'status-badge status-' + data.status;

                if (data.status === 'completed') {
                    loadResults(data);
                } else if (data.status === 'failed') {
                    showError(data.error_message || 'Search failed');
                    document.getElementById('progressContainer').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                } else {
                    // Continue polling
                    setTimeout(pollSearchStatus, 1000);
                }
            } catch (error) {
                showError('Failed to check search status');
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Load results
        async function loadResults(statusData) {
            const searchTime = ((Date.now() - searchStartTime) / 1000).toFixed(1);

            // Store sequence length globally
            sequenceLength = statusData.sequence_length;

            // Update stats
            document.getElementById('totalPairs').textContent = statusData.total_pairs.toLocaleString();
            document.getElementById('sequenceLength').textContent = statusData.sequence_length.toLocaleString();
            document.getElementById('searchTime').textContent = searchTime + 's';
            document.getElementById('pairCount').textContent = statusData.total_pairs.toLocaleString();

            // Hide progress, show results
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;

            // Load table data
            if (statusData.total_pairs > 0) {
                await loadTableData();
            }
        }

        // Load table data with server-side pagination
        async function loadTableData() {
            const response = await fetch(`/api/results/${currentSessionId}?page=1&per_page=1000`);
            const data = await response.json();

            // Store pairs globally for genomic browser
            allPairs = data.pairs;

            // Populate pair selector
            const selector = document.getElementById('pairSelector');
            selector.innerHTML = '<option value="all">Show All Pairs (Overview)</option>';
            data.pairs.forEach((pair, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Pair ${index + 1}: ${pair.start}-${pair.end} / ${pair.comp_start}-${pair.comp_end}`;
                selector.appendChild(option);
            });

            if (dataTable) {
                dataTable.destroy();
            }

            const tableBody = document.querySelector('#resultsTable tbody');
            tableBody.innerHTML = '';

            data.pairs.forEach(pair => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${pair.start}</td>
                    <td>${pair.end}</td>
                    <td><code>${pair.rvd}</code></td>
                    <td>${pair.comp_start}</td>
                    <td>${pair.comp_end}</td>
                    <td><code>${pair.comp_rvd}</code></td>
                    <td>${pair.spacer_length}</td>
                    <td>${pair.tale_length}</td>
                `;
            });

            dataTable = $('#resultsTable').DataTable({
                pageLength: 25,
                order: [[0, 'asc']],
                responsive: true
            });

            // Render genomic browser
            renderGenomicBrowser();
        }

        // Export results
        function exportResults(format) {
            if (!currentSessionId) return;
            window.location.href = `/api/export/${currentSessionId}?format=${format}`;
        }

        // Reset search
        function resetSearch() {
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('searchForm').reset();
            currentSessionId = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'block';
        }

        // Toggle between browser and table view
        function toggleView(view, highlightPairIndex = null) {
            const browserView = document.getElementById('browserView');
            const tableView = document.getElementById('tableView');
            const browserBtn = document.getElementById('browserViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');

            if (view === 'browser') {
                browserView.style.display = 'block';
                tableView.style.display = 'none';
                browserBtn.classList.add('active');
                tableBtn.classList.remove('active');
            } else {
                browserView.style.display = 'none';
                tableView.style.display = 'block';
                browserBtn.classList.remove('active');
                tableBtn.classList.add('active');

                // If a pair index is provided, filter to that row
                if (highlightPairIndex !== null && dataTable) {
                    // Clear any existing search
                    dataTable.search('').draw();

                    // Navigate to the page containing this row and highlight it
                    const rowsPerPage = dataTable.page.len();
                    const pageNumber = Math.floor(highlightPairIndex / rowsPerPage);
                    dataTable.page(pageNumber).draw('page');

                    // Highlight the row
                    setTimeout(() => {
                        const rows = document.querySelectorAll('#resultsTable tbody tr');
                        const targetRow = rows[highlightPairIndex % rowsPerPage];
                        if (targetRow) {
                            // Remove previous highlights
                            rows.forEach(r => {
                                r.classList.remove('highlighted-row');
                            });

                            // Highlight target row with prominent styling
                            targetRow.classList.add('highlighted-row');
                            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // Remove highlight after 5 seconds (increased for visibility)
                            setTimeout(() => {
                                targetRow.classList.remove('highlighted-row');
                            }, 5000);
                        }
                    }, 100);
                }
            }
        }

        // Toggle visibility filter for legend items
        function toggleFilter(filterType) {
            visibilityFilters[filterType] = !visibilityFilters[filterType];

            // Update legend visual state
            const legendId = 'legend' + filterType.charAt(0).toUpperCase() + filterType.slice(1);
            const legendItem = document.getElementById(legendId);

            if (visibilityFilters[filterType]) {
                legendItem.classList.remove('disabled');
            } else {
                legendItem.classList.add('disabled');
            }

            // Re-render the browser
            renderGenomicBrowser();
        }

        // Handle pair selection change
        function onPairChange() {
            // Reset zoom when switching pairs for clean view
            currentZoom = 100;
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomLabel').textContent = '100%';

            // Re-render with new pair selection
            renderGenomicBrowser();
        }

        // Update zoom level - HORIZONTAL ONLY
        // Zoom only scales the SVG width, never filters or scales vertically
        function updateZoom(value) {
            currentZoom = parseInt(value);
            document.getElementById('zoomLabel').textContent = currentZoom + '%';

            // Re-render with new zoom level
            // Zoom ONLY affects horizontal scaling of SVG width
            renderGenomicBrowser();
        }

        // Handle view mode change
        function onViewModeChange() {
            currentViewMode = document.getElementById('viewModeSelector').value;

            // Show/hide navigation controls for region view
            const navControls = document.getElementById('navigationControls');
            const miniMap = document.getElementById('miniMap');

            if (currentViewMode === 'region') {
                navControls.style.display = 'flex';
                miniMap.style.display = 'block';
                // Initialize region to start of sequence
                currentRegionStart = 0;
                currentRegionEnd = Math.min(regionSize, sequenceLength);
            } else {
                navControls.style.display = 'none';
                miniMap.style.display = 'none';
            }

            renderGenomicBrowser();
        }

        // Handle color mode change
        function onColorModeChange() {
            currentColorMode = document.getElementById('colorModeSelector').value;
            renderGenomicBrowser();
        }

        // Jump to specific position
        function jumpToPosition() {
            const position = parseInt(document.getElementById('jumpPosition').value);

            if (isNaN(position) || position < 0 || position >= sequenceLength) {
                alert('Please enter a valid position between 0 and ' + sequenceLength);
                return;
            }

            // Center region on position
            currentRegionStart = Math.max(0, position - regionSize / 2);
            currentRegionEnd = Math.min(sequenceLength, currentRegionStart + regionSize);

            // Adjust if we hit the end
            if (currentRegionEnd === sequenceLength && currentRegionStart > 0) {
                currentRegionStart = Math.max(0, sequenceLength - regionSize);
            }

            renderGenomicBrowser();
        }

        // Navigate to previous/next region
        function navigateRegion(direction) {
            const step = regionSize; // No overlap - move by full region size

            if (direction === 'prev') {
                currentRegionStart = Math.max(0, currentRegionStart - step);
                currentRegionEnd = Math.min(sequenceLength, currentRegionStart + regionSize);
            } else {
                currentRegionStart = Math.min(sequenceLength - regionSize, currentRegionStart + step);
                currentRegionEnd = Math.min(sequenceLength, currentRegionStart + regionSize);
            }

            renderGenomicBrowser();
        }

        // Export current view as SVG
        function exportSVG() {
            const svg = document.getElementById('genomicBrowser');
            const serializer = new XMLSerializer();
            let svgStr = serializer.serializeToString(svg);

            // Add CSS styles inline for proper rendering
            const styles = `
                <style>
                    .tale-forward { fill: #4DA3FF; stroke: #3385E6; stroke-width: 2; }
                    .tale-reverse { fill: #00C99C; stroke: #00A67E; stroke-width: 2; }
                    .spacer-region { fill: #A0A0A0; opacity: 0.3; }
                    .sequence-track { stroke: #404040; stroke-width: 2; }
                    .position-marker { stroke: #A0A0A0; stroke-width: 1; stroke-dasharray: 2,2; }
                    .position-label { fill: #A0A0A0; font-size: 10px; font-family: 'Courier New', monospace; }
                    .tale-label { fill: white; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600; }
                    .track-label { fill: #A0A0A0; font-size: 10px; font-family: 'Courier New', monospace; font-weight: 600; }
                </style>
            `;

            // Insert styles at beginning of SVG
            svgStr = svgStr.replace('<svg', styles + '<svg');

            // Create download
            const blob = new Blob([svgStr], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'genomic_browser_view.svg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Get color for a TALE based on color mode
        function getColorForPair(pair, isForward) {
            if (currentColorMode === 'strand') {
                return isForward ? '#4DA3FF' : '#00C99C';
            } else if (currentColorMode === 'length') {
                // Color gradient from short (blue) to long (red)
                const minLen = Math.min(...allPairs.map(p => p.tale_length));
                const maxLen = Math.max(...allPairs.map(p => p.tale_length));
                const normalized = (pair.tale_length - minLen) / (maxLen - minLen || 1);
                const hue = 240 - (normalized * 60); // 240 (blue) to 180 (cyan) to 120 (green)
                return `hsl(${hue}, 70%, 50%)`;
            } else if (currentColorMode === 'spacer') {
                // Color gradient from short spacer (blue) to long spacer (red)
                const minSpacer = Math.min(...allPairs.map(p => p.spacer_length));
                const maxSpacer = Math.max(...allPairs.map(p => p.spacer_length));
                const normalized = (pair.spacer_length - minSpacer) / (maxSpacer - minSpacer || 1);
                const hue = 240 - (normalized * 120); // 240 (blue) to 0 (red)
                return `hsl(${hue}, 70%, 50%)`;
            }
            return isForward ? '#4DA3FF' : '#00C99C';
        }

        // Draw a track label and line
        function drawTrack(g, x, y, width, label) {
            // Track line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x);
            line.setAttribute('y1', y);
            line.setAttribute('x2', x + width);
            line.setAttribute('y2', y);
            line.setAttribute('class', 'sequence-track');
            g.appendChild(line);

            // Track label
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x - 10);
            text.setAttribute('y', y + 4);
            text.setAttribute('text-anchor', 'end');
            text.setAttribute('class', 'track-label');
            text.textContent = label;
            g.appendChild(text);
        }

        // Draw compact TALE rectangle
        function drawCompactTALE(g, x, y, width, height, cssClass, pair, pairIndex, isForward) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', Math.max(0, x));
            rect.setAttribute('y', y - height / 2);
            rect.setAttribute('width', Math.max(1, width));
            rect.setAttribute('height', height);
            rect.setAttribute('class', cssClass);
            rect.setAttribute('rx', 2);
            rect.style.cursor = 'pointer';

            // Apply color based on mode
            const color = getColorForPair(pair, isForward);
            rect.style.fill = color;

            const strandType = isForward ? 'Forward' : 'Reverse';
            const pos = isForward ? `${pair.start}-${pair.end}` : `${pair.comp_start}-${pair.comp_end}`;
            const rvd = isForward ? pair.rvd : pair.comp_rvd;

            addTooltip(rect,
                `${strandType} TALE (Pair ${pairIndex + 1})<br>` +
                `Position: ${pos}<br>` +
                `Length: ${pair.tale_length} bp<br>` +
                `Spacer: ${pair.spacer_length} bp<br>` +
                `RVD: ${rvd}<br>` +
                `<em>Click to view in table</em>`
            );

            rect.addEventListener('click', () => {
                toggleView('table', pairIndex);
            });

            g.appendChild(rect);
        }

        // Render mini-map
        function renderMiniMap() {
            const miniMap = document.getElementById('miniMap');
            const viewport = document.getElementById('miniMapViewport');

            if (currentViewMode !== 'region' || !miniMap) return;

            // Clear existing TALE markers
            const existingTales = miniMap.querySelectorAll('.mini-map-tale');
            existingTales.forEach(el => el.remove());

            // Position viewport indicator
            const viewportStart = (currentRegionStart / sequenceLength) * 100;
            const viewportWidth = ((currentRegionEnd - currentRegionStart) / sequenceLength) * 100;
            viewport.style.left = viewportStart + '%';
            viewport.style.width = viewportWidth + '%';

            // Add TALE markers (only render visible subset for performance)
            const maxMarkers = 100;
            const step = Math.ceil(allPairs.length / maxMarkers);

            for (let i = 0; i < allPairs.length; i += step) {
                const pair = allPairs[i];

                // Forward TALE
                const fStart = (pair.start / sequenceLength) * 100;
                const fWidth = ((pair.end - pair.start) / sequenceLength) * 100;
                const fDiv = document.createElement('div');
                fDiv.className = 'mini-map-tale forward';
                fDiv.style.left = fStart + '%';
                fDiv.style.width = Math.max(0.5, fWidth) + '%';
                miniMap.appendChild(fDiv);

                // Reverse TALE
                const rStart = (pair.comp_start / sequenceLength) * 100;
                const rWidth = ((pair.comp_end - pair.comp_start) / sequenceLength) * 100;
                const rDiv = document.createElement('div');
                rDiv.className = 'mini-map-tale reverse';
                rDiv.style.left = rStart + '%';
                rDiv.style.width = Math.max(0.5, rWidth) + '%';
                miniMap.appendChild(rDiv);
            }

            // Add click handler to mini-map for navigation
            miniMap.onclick = function(e) {
                // Don't handle if clicking on viewport (it's for dragging)
                if (e.target === viewport) return;

                const rect = miniMap.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickPercent = clickX / rect.width;
                const clickPosition = Math.floor(clickPercent * sequenceLength);

                // Center region on clicked position
                currentRegionStart = Math.max(0, clickPosition - regionSize / 2);
                currentRegionEnd = Math.min(sequenceLength, currentRegionStart + regionSize);

                // Adjust if we hit the end
                if (currentRegionEnd === sequenceLength && currentRegionStart > 0) {
                    currentRegionStart = Math.max(0, sequenceLength - regionSize);
                }

                renderGenomicBrowser();
            };

            // Update current region display
            document.getElementById('currentRegion').textContent =
                `Viewing: ${currentRegionStart.toLocaleString()} - ${currentRegionEnd.toLocaleString()} bp`;
        }

        // Render genomic browser - COMPLETELY REWRITTEN FOR HORIZONTAL-ONLY ZOOM
        function renderGenomicBrowser() {
            if (!allPairs || allPairs.length === 0) return;

            const svg = document.getElementById('genomicBrowser');
            const container = document.getElementById('browserSvgContainer');
            const selectedPair = document.getElementById('pairSelector').value;

            // Clear existing content
            svg.innerHTML = '';

            // Get container width dynamically
            const containerWidth = container.clientWidth || 1000;

            // Determine view mode (compact, standard, region)
            let effectiveViewMode = currentViewMode;

            // ===== CRITICAL: VIEW BOUNDS ARE INDEPENDENT OF ZOOM =====
            // Zoom ONLY scales SVG width, NEVER filters what's shown
            let pairsToDisplay = [];
            let viewStart = 0;
            let viewEnd = sequenceLength;

            if (selectedPair === 'all') {
                // Show all pairs (overview mode)
                if (currentViewMode === 'region') {
                    // Region view: filter pairs to visible region (INDEPENDENT of zoom)
                    pairsToDisplay = allPairs.filter(pair =>
                        (pair.start >= currentRegionStart && pair.start <= currentRegionEnd) ||
                        (pair.comp_end >= currentRegionStart && pair.comp_end <= currentRegionEnd) ||
                        (pair.start <= currentRegionStart && pair.comp_end >= currentRegionEnd)
                    );
                    viewStart = currentRegionStart;
                    viewEnd = currentRegionEnd;
                } else {
                    // Standard or compact view: ALWAYS show ALL pairs
                    // Zoom ONLY scales horizontal width, NEVER filters
                    pairsToDisplay = allPairs;
                    viewStart = 0;
                    viewEnd = sequenceLength;
                }
            } else {
                // Single pair detail view
                const pairIndex = parseInt(selectedPair);
                const pair = allPairs[pairIndex];
                pairsToDisplay = [pair];

                // Define view bounds based on pair location (INDEPENDENT of zoom)
                // Show the pair plus reasonable context padding
                const pairLength = pair.comp_end - pair.start;
                const padding = Math.max(500, pairLength * 2);

                viewStart = Math.max(0, pair.start - padding);
                viewEnd = Math.min(sequenceLength, pair.comp_end + padding);

                // Adjust if we hit boundaries
                if (viewStart === 0 && viewEnd < sequenceLength) {
                    viewEnd = Math.min(sequenceLength, pairLength + 2 * padding);
                } else if (viewEnd === sequenceLength && viewStart > 0) {
                    viewStart = Math.max(0, sequenceLength - (pairLength + 2 * padding));
                }
            }

            // ===== CALCULATE DIMENSIONS =====
            const margin = { top: 60, right: 40, bottom: 80, left: 60 };

            // HORIZONTAL ZOOM: Scale SVG width only
            // Higher zoom = wider SVG = more horizontal space = horizontal scrollbar appears
            const svgWidth = containerWidth * (currentZoom / 100);

            // HEIGHT: Fixed based on content, NEVER affected by zoom
            let svgHeight;
            if (selectedPair === 'all') {
                if (effectiveViewMode === 'compact') {
                    // Compact mode: fixed height for two tracks
                    svgHeight = 300;
                } else {
                    // Standard mode: height based on ALL pairs being displayed
                    // Use pairsToDisplay.length since we're showing what's in the view
                    // But this is NOT affected by zoom - only by region filtering
                    svgHeight = Math.max(400, 180 + pairsToDisplay.length * 10);
                }
            } else {
                // Single pair: fixed height
                svgHeight = 300;
            }

            svg.setAttribute('width', svgWidth);
            svg.setAttribute('height', svgHeight);

            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            // Create main group with margins
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
            svg.appendChild(g);

            // Calculate scale (pixels per base pair)
            // This is where zoom takes effect - higher zoom means larger scale (more pixels per bp)
            const regionLength = viewEnd - viewStart;
            const scale = width / regionLength;

            // Draw sequence track (chromosome/DNA backbone)
            const trackY = selectedPair === 'all' ? height / 2 : height / 2;
            const track = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            track.setAttribute('x1', 0);
            track.setAttribute('y1', trackY);
            track.setAttribute('x2', width);
            track.setAttribute('y2', trackY);
            track.setAttribute('class', 'sequence-track');
            g.appendChild(track);

            // Add position markers
            const markerInterval = Math.max(100, selectedPair === 'all' ?
                Math.pow(10, Math.floor(Math.log10(regionLength / 10))) :
                Math.pow(10, Math.floor(Math.log10(regionLength / 8))));

            for (let pos = Math.ceil(viewStart / markerInterval) * markerInterval;
                 pos <= viewEnd;
                 pos += markerInterval) {
                const x = (pos - viewStart) * scale;

                // Marker line
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                marker.setAttribute('x1', x);
                marker.setAttribute('y1', trackY - 10);
                marker.setAttribute('x2', x);
                marker.setAttribute('y2', trackY + 10);
                marker.setAttribute('class', 'position-marker');
                g.appendChild(marker);

                // Position label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', trackY + 30);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('class', 'position-label');
                label.textContent = pos.toLocaleString() + ' bp';
                g.appendChild(label);
            }

            // Draw TALE pairs
            if (selectedPair === 'all') {
                if (effectiveViewMode === 'compact') {
                    // Compact mode: split tracks for forward and reverse
                    const forwardTrackY = height / 2 - 40;
                    const reverseTrackY = height / 2 + 40;

                    // Draw tracks
                    drawTrack(g, 0, forwardTrackY, width, 'Forward');
                    drawTrack(g, 0, reverseTrackY, width, 'Reverse');

                    // Draw TALEs as thin rectangles on separate tracks
                    pairsToDisplay.forEach((pair, index) => {
                        const originalIndex = allPairs.indexOf(pair);

                        // Forward TALE
                        if (visibilityFilters.forward) {
                            const fx = (pair.start - viewStart) * scale;
                            const fw = Math.max(1, (pair.end - pair.start) * scale);
                            drawCompactTALE(g, fx, forwardTrackY, fw, 6, 'tale-forward', pair, originalIndex, true);
                        }

                        // Reverse TALE
                        if (visibilityFilters.reverse) {
                            const rx = (pair.comp_start - viewStart) * scale;
                            const rw = Math.max(1, (pair.comp_end - pair.comp_start) * scale);
                            drawCompactTALE(g, rx, reverseTrackY, rw, 6, 'tale-reverse', pair, originalIndex, false);
                        }
                    });
                } else {
                    // Standard mode: stack pairs vertically
                    pairsToDisplay.forEach((pair, index) => {
                        const pairY = 80 + index * 10;
                        const originalIndex = allPairs.indexOf(pair);
                        drawTALEPair(g, pair, viewStart, scale, pairY, false, originalIndex);
                    });
                }
            } else {
                // Detail mode: show on forward and reverse strands
                const pair = pairsToDisplay[0];
                const actualPairIndex = parseInt(selectedPair);
                drawTALEPair(g, pair, viewStart, scale, trackY, true, actualPairIndex);
            }

            // Add title
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', width / 2);
            title.setAttribute('y', -30);
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('class', 'position-label');
            title.style.fontSize = '14px';
            title.style.fontWeight = 'bold';

            let titleText = '';
            if (selectedPair === 'all') {
                const modeLabel = effectiveViewMode === 'compact' ? 'Compact View' : 'Standard View';
                titleText = `Genomic Overview (${modeLabel}): ${pairsToDisplay.length} TALE Pairs (${Math.round(regionLength).toLocaleString()} bp)`;
            } else {
                titleText = `TALE Pair Detail View: ${Math.round(regionLength).toLocaleString()} bp`;
            }
            title.textContent = titleText;
            g.appendChild(title);

            // Render mini-map if in region mode
            renderMiniMap();
        }

        // Draw individual TALE pair
        function drawTALEPair(g, pair, viewStart, scale, centerY, detailMode, pairIndex) {
            const forwardY = detailMode ? centerY - 30 : centerY;
            const reverseY = detailMode ? centerY + 30 : centerY;

            // Calculate positions
            const forwardX = (pair.start - viewStart) * scale;
            const forwardWidth = (pair.end - pair.start) * scale;
            const reverseX = (pair.comp_start - viewStart) * scale;
            const reverseWidth = (pair.comp_end - pair.comp_start) * scale;
            const spacerX = (pair.end - viewStart) * scale;
            const spacerWidth = (pair.comp_start - pair.end) * scale;

            const boxHeight = detailMode ? 25 : 8;

            // Draw spacer region (if visible and in detail mode)
            if (detailMode && spacerWidth > 0 && visibilityFilters.spacer) {
                const spacer = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                spacer.setAttribute('x', spacerX);
                spacer.setAttribute('y', centerY - boxHeight / 4);
                spacer.setAttribute('width', spacerWidth);
                spacer.setAttribute('height', boxHeight / 2);
                spacer.setAttribute('class', 'spacer-region');
                spacer.setAttribute('rx', 2);
                addTooltip(spacer, `Spacer Region<br>Length: ${pair.spacer_length} bp<br>Position: ${pair.end}-${pair.comp_start}`);
                g.appendChild(spacer);
            }

            // Draw forward TALE (if filter enabled)
            if (visibilityFilters.forward) {
                const forward = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                forward.setAttribute('x', forwardX);
                forward.setAttribute('y', forwardY - boxHeight / 2);
                forward.setAttribute('width', Math.max(2, forwardWidth));
                forward.setAttribute('height', boxHeight);
                forward.setAttribute('class', 'tale-forward');
                forward.setAttribute('rx', 4);
                forward.style.cursor = 'pointer';

                // Apply color based on mode
                const forwardColor = getColorForPair(pair, true);
                forward.style.fill = forwardColor;

                addTooltip(forward,
                    `Forward TALE ${detailMode ? '' : '(Pair ' + (pairIndex + 1) + ')'}<br>` +
                    `Position: ${pair.start}-${pair.end}<br>` +
                    `Length: ${pair.tale_length} bp<br>` +
                    `Spacer: ${pair.spacer_length} bp<br>` +
                    `RVD: ${pair.rvd}<br>` +
                    `<em>Click to view in table</em>`
                );

                // Add click handler to navigate to table view
                forward.addEventListener('click', () => {
                    toggleView('table', pairIndex);
                });

                g.appendChild(forward);
            }

            // Draw reverse TALE (if filter enabled)
            if (visibilityFilters.reverse) {
                const reverse = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                reverse.setAttribute('x', reverseX);
                reverse.setAttribute('y', reverseY - boxHeight / 2);
                reverse.setAttribute('width', Math.max(2, reverseWidth));
                reverse.setAttribute('height', boxHeight);
                reverse.setAttribute('class', 'tale-reverse');
                reverse.setAttribute('rx', 4);
                reverse.style.cursor = 'pointer';

                // Apply color based on mode
                const reverseColor = getColorForPair(pair, false);
                reverse.style.fill = reverseColor;

                addTooltip(reverse,
                    `Reverse TALE ${detailMode ? '' : '(Pair ' + (pairIndex + 1) + ')'}<br>` +
                    `Position: ${pair.comp_start}-${pair.comp_end}<br>` +
                    `Length: ${pair.tale_length} bp<br>` +
                    `Spacer: ${pair.spacer_length} bp<br>` +
                    `RVD: ${pair.comp_rvd}<br>` +
                    `<em>Click to view in table</em>`
                );

                // Add click handler to navigate to table view
                reverse.addEventListener('click', () => {
                    toggleView('table', pairIndex);
                });

                g.appendChild(reverse);
            }

            // Add labels in detail mode
            if (detailMode && forwardWidth > 40) {
                if (visibilityFilters.forward) {
                    const fLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    fLabel.setAttribute('x', forwardX + forwardWidth / 2);
                    fLabel.setAttribute('y', forwardY + 4);
                    fLabel.setAttribute('text-anchor', 'middle');
                    fLabel.setAttribute('class', 'tale-label');
                    fLabel.textContent = 'FWD';
                    g.appendChild(fLabel);
                }

                if (visibilityFilters.reverse) {
                    const rLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    rLabel.setAttribute('x', reverseX + reverseWidth / 2);
                    rLabel.setAttribute('y', reverseY + 4);
                    rLabel.setAttribute('text-anchor', 'middle');
                    rLabel.setAttribute('class', 'tale-label');
                    rLabel.textContent = 'REV';
                    g.appendChild(rLabel);
                }
            }

            // Add connecting lines in detail mode
            if (detailMode && visibilityFilters.forward && visibilityFilters.reverse) {
                const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line1.setAttribute('x1', forwardX + forwardWidth);
                line1.setAttribute('y1', forwardY);
                line1.setAttribute('x2', reverseX);
                line1.setAttribute('y2', reverseY);
                line1.setAttribute('stroke', '#A0A0A0');
                line1.setAttribute('stroke-width', 1);
                line1.setAttribute('stroke-dasharray', '3,3');
                g.appendChild(line1);
            }
        }

        // Add tooltip functionality
        function addTooltip(element, html) {
            const tooltip = document.getElementById('browserTooltip');

            element.addEventListener('mouseenter', (e) => {
                tooltip.innerHTML = '<div class="tooltip-content">' + html + '</div>';
                tooltip.style.display = 'block';
            });

            element.addEventListener('mousemove', (e) => {
                tooltip.style.left = (e.pageX + 15) + 'px';
                tooltip.style.top = (e.pageY - 10) + 'px';
            });

            element.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
    </script>
</body>
</html>




